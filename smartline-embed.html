<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Talk to Strawberry â€” SmartLine Agent</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 24px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fafafa; }
    .card { background: #fff; border-radius: 16px; padding: 32px; box-shadow: 0 4px 24px rgba(0,0,0,.08); max-width: 400px; width: 100%; text-align: center; }
    h2 { margin: 0 0 8px; font-size: 1.25rem; color: #1a1a1a; }
    .sub { color: #666; font-size: 0.875rem; margin-bottom: 24px; }
    button { background: #000; color: #fff; border: none; padding: 14px 28px; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; transition: opacity .2s; }
    button:hover { opacity: .9; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .recording { background: #dc2626; animation: pulse 1.5s infinite; }
    @keyframes pulse { 50% { opacity: .8; } }
    .status { margin-top: 16px; font-size: 0.875rem; color: #666; }
    .error { color: #dc2626; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Talk to Strawberry</h2>
    <p class="sub">Just start speaking. Any language. She'll follow.</p>
    <button id="btn" type="button">Start conversation</button>
    <p class="status" id="status"></p>
  </div>

  <script type="module">
    // API base: ?api=URL in page URL, or window.SMARTLINE_API_BASE, or same origin
    const params = new URLSearchParams(window.location.search);
    const API_BASE = params.get('api') || window.SMARTLINE_API_BASE || window.location.origin;

    const btn = document.getElementById('btn');
    const status = document.getElementById('status');

    function setStatus(msg, isError = false) {
      status.textContent = msg;
      status.className = 'status' + (isError ? ' error' : '');
    }

    let session = null;

    async function startSession() {
      btn.disabled = true;
      setStatus('Connecting...');
      try {
        const tokenRes = await fetch(`${API_BASE}/api/smartline/token`);
        if (!tokenRes.ok) throw new Error('Failed to get token');
        const { token } = await tokenRes.json();
        if (!token) throw new Error('No token');

        const { RealtimeAgent, RealtimeSession, tool } = await import('https://esm.sh/@openai/agents@0.4.11/realtime');
        const { z } = await import('https://esm.sh/zod@3.23.8');

        const toolFetch = (name, args) =>
          fetch(`${API_BASE}/api/smartline/tool`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ toolName: name, args })
          }).then(r => r.json()).then(r => JSON.stringify(r));

        const agent = new RealtimeAgent({
          name: 'Strawberry',
          instructions: `You are Strawberry from SmartLine Agent. Be warm and helpful. Ask what kind of business they run and what they need. Pitch SmartLine (calls, SMS, WhatsApp when they can't). Setup $1,000. Match their language. 2-3 sentences max.`,
          tools: [
            tool({ name: 'lookup_services', description: 'Look up SmartLine services, pricing.', parameters: z.object({ query: z.string(), category: z.string().optional() }), execute: ({ query, category }) => toolFetch('lookup_services', { query, category }) }),
            tool({ name: 'lookup_faq', description: 'Look up FAQs.', parameters: z.object({ question: z.string(), topic: z.string().optional() }), execute: ({ question, topic }) => toolFetch('lookup_faq', { question, topic }) }),
            tool({ name: 'lookup_objection', description: 'Objection handling.', parameters: z.object({ objection: z.string() }), execute: ({ objection }) => toolFetch('lookup_objection', { objection }) }),
            tool({ name: 'lookup_case_study', description: 'Case studies.', parameters: z.object({ industry: z.string().optional(), topic: z.string().optional() }), execute: (a) => toolFetch('lookup_case_study', a) }),
            tool({ name: 'lookup_client_info', description: 'SmartLine info.', parameters: z.object({ field: z.string().optional() }), execute: ({ field }) => toolFetch('lookup_client_info', { field }) })
          ]
        });

        session = new RealtimeSession(agent, { transport: 'webrtc', model: 'gpt-realtime', config: { audio: { output: { voice: 'shimmer' } } } });
        await session.connect({ apiKey: token });
        btn.textContent = 'End conversation';
        btn.classList.add('recording');
        setStatus('Speak now. Click to end.');
      } catch (err) {
        setStatus(err.message || 'Connection failed', true);
        btn.disabled = false;
      }
    }

    function endSession() {
      if (session) {
        session.close();
        session = null;
      }
      btn.textContent = 'Start conversation';
      btn.classList.remove('recording');
      btn.disabled = false;
      setStatus('');
    }

    btn.addEventListener('click', () => {
      if (session) endSession();
      else startSession();
    });
  </script>
</body>
</html>
